# 任务记录：多数据源 + VIP用户系统

> 分支：`feature/multi-datasource-vip-system`  
> 创建日期：2024-12-11  
> 状态：🚧 进行中

## 背景

原 Wind API 已不可用，需要：
1. 重构数据获取层，支持多数据源（Tushare、AKShare等）
2. 新增用户VIP系统，按等级分配不同数量的股票
3. **架构升级为前后端分离模式，带管理后台**

## 已确认的设计决策

| 项目         | 决策                    | 备注                           |
| ------------ | ----------------------- | ------------------------------ |
| VIP等级体系  | ✅ 5级（0-4）            | 后台可配置                     |
| 股票分配策略 | ✅ 随机分配              |                                |
| 数据源优先级 | ✅ Tushare → AKShare     | Token 配置在 .env.local        |
| 技术架构     | ✅ 前后端分离 + 管理后台 | FastAPI + Vue 3 + Element Plus |

---

## 技术架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (待定)                               │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│   │  管理后台   │  │  用户端    │   │   看板      │            │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
└──────────┼────────────────┼────────────────┼────────────────────┘
           │                │                │
           ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     后端 API (FastAPI)                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ 用户管理 │ │ 股票分配 │ │ 数据服务 │ │ 系统配置 │           │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │
│       └────────────┴────────────┴────────────┘                  │
│                          │                                      │
│  ┌───────────────────────┴───────────────────────┐             │
│  │              业务逻辑层                         │             │
│  │  SignalEngine │ StockAllocator │ DataFetcher  │             │
│  └───────────────────────┬───────────────────────┘             │
└──────────────────────────┼──────────────────────────────────────┘
                           │
┌──────────────────────────┼──────────────────────────────────────┐
│                     数据层                                       │
│  ┌─────────────┐  ┌─────────────────────────────────┐          │
│  │   SQLite    │  │    DataSourceManager            │          │
│  │  /PostgreSQL│  │  ┌─────────┐ ┌─────────┐       │          │
│  │             │  │  │Tushare  │ │AKShare  │       │          │
│  │ - users     │  │  └─────────┘ └─────────┘       │          │
│  │ - stocks    │  └─────────────────────────────────┘          │
│  │ - allocations│                                               │
│  │ - configs   │                                                │
│  └─────────────┘                                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 任务拆解

### Phase 0 · 项目重构 & 基础架构

| #   | 任务                        | 状态     | 备注                               |
| --- | --------------------------- | -------- | ---------------------------------- |
| 0.1 | 项目目录结构重组            | ✅ 已完成 | backend/, frontend/                |
| 0.2 | FastAPI 项目初始化          | ✅ 已完成 | 路由、中间件、异常处理             |
| 0.3 | 数据库模型设计 (SQLAlchemy) | ✅ 已完成 | User, Stock, Allocation, Config 表 |
| 0.4 | 用户认证系统 (JWT)          | ✅ 已完成 | 登录、注册、权限控制               |
| 0.5 | 环境变量 & 配置管理         | ✅ 已完成 | pydantic-settings, .env.local      |

### Phase 1 · 多数据源架构

| #   | 任务                       | 状态     | 备注                                                |
| --- | -------------------------- | -------- | --------------------------------------------------- |
| 1.1 | 设计 `DataSource` 抽象基类 | ✅ 已完成 | 定义统一接口：get_daily_data, get_realtime_quote 等 |
| 1.2 | 实现 `TushareDataSource`   | ✅ 已完成 | 需要 token 配置                                     |
| 1.3 | 实现 `AKShareDataSource`   | ✅ 已完成 | 免费，无需 token                                    |
| 1.4 | 实现 `DataSourceManager`   | ✅ 已完成 | 支持优先级、自动降级、健康检查                      |
| 1.5 | 数据源 API 接口            | ✅ 已完成 | 暴露给前端调用                                      |

### Phase 2 · 用户 VIP 系统

| #   | 任务                              | 状态     | 备注                                     |
| --- | --------------------------------- | -------- | ---------------------------------------- |
| 2.1 | 用户模型 & CRUD API               | ✅ 已完成 | 字段：id, name, vip_level, created_at 等 |
| 2.2 | VIP 等级配置（后台可调）          | ✅ 已完成 | 存入数据库，支持动态修改                 |
| 2.3 | 实现股票分配策略 `StockAllocator` | ✅ 已完成 | 随机分配，按 VIP 等级控制数量            |
| 2.4 | 分配记录存储 & 查询               | ✅ 已完成 | allocations 表                           |
| 2.5 | 用户分配结果导出 API              | ⬜ 待开始 | JSON / Excel                             |

### Phase 3 · 管理后台 API

| #   | 任务               | 状态     | 备注                    |
| --- | ------------------ | -------- | ----------------------- |
| 3.1 | 用户管理接口       | ✅ 已完成 | 增删改查、VIP 升降级    |
| 3.2 | 股票池管理接口     | ✅ 已完成 | 导入、编辑、删除        |
| 3.3 | 系统配置接口       | ✅ 已完成 | VIP等级配置、分配策略等 |
| 3.4 | 数据源状态监控接口 | ✅ 已完成 | 健康检查、切换日志      |

### Phase 4 · 信号系统

| #   | 任务                | 状态     | 备注                         |
| --- | ------------------- | -------- | ---------------------------- |
| 4.1 | 重构 `SignalEngine` | ⬜ 待开始 | 适配新数据源                 |
| 4.2 | 信号 API            | ⬜ 待开始 | 生成、查询、按用户过滤       |
| 4.3 | 用户维度的信号分发  | ⬜ 待开始 | 每个用户只收到自己的股票信号 |

### Phase 5 · 前端（Vue 3 + Element Plus）

| #   | 任务          | 状态     | 备注                 |
| --- | ------------- | -------- | -------------------- |
| 5.1 | 管理后台界面  | ✅ 已完成 | 用户管理、配置管理   |
| 5.2 | 用户登录/注册 | ✅ 已完成 |                      |
| 5.3 | 用户个人看板  | ✅ 已完成 | 查看自己的股票、信号 |
| 5.4 | 数据可视化    | ⬜ 待开始 | 行情图表等           |

---

## VIP 等级设计 ✅ 已确认

| VIP等级 | 名称     | 股票数量上限 | 说明     |
| ------- | -------- | ------------ | -------- |
| 0       | 免费用户 | 5            | 基础体验 |
| 1       | VIP1     | 10           |          |
| 2       | VIP2     | 20           |          |
| 3       | VIP3     | 50           |          |
| 4       | SVIP     | 不限         | 全量股票 |

> 💡 等级配置存储在数据库，管理员可在后台动态调整

---

## 股票分配策略 ✅ 已确认

采用 **随机分配** 策略：
- 从总股票池中随机抽取
- 数量由用户 VIP 等级决定
- 每次分配记录入库，支持历史查询

---

## 变更日志

| 日期       | 变更内容                                                                                                                                                                           |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2024-12-11 | 创建任务文档，建立分支                                                                                                                                                             |
| 2024-12-11 | 确认 VIP 等级、分配策略、数据源优先级                                                                                                                                              |
| 2024-12-11 | 架构升级为前后端分离，新增管理后台需求                                                                                                                                             |
| 2024-12-11 | 管理后台支持管理员创建用户                                                                                                                                                         |
| 2024-12-11 | 确认前端技术栈：Vue 3 + Element Plus                                                                                                                                               |
| 2024-12-11 | 完成后端 API 开发（Phase 0-3）                                                                                                                                                     |
| 2024-12-11 | 完成前端基础页面开发（Phase 5）                                                                                                                                                    |
| 2025-12-11 | 重新启用 AKShare 兜底并重跑信号；后续确认 .env.local 已加载但 Tushare token 无对应接口权限（doc_id=108 提示），Tushare 不可用；AKShare 因远端断开（Eastmoney）全部失败，信号未更新 |
| 2025-12-11 | 新增 TUSHARE_BASE_URL 配置，Tushare 请求域支持自定义（如 http://tushare.nlink.vip）；使用新 token + 自定义域重跑信号，已成功（Buy/Sell/Hold 更新完成）                             |
| 2025-12-11 | 关闭 AKShare，仅用 Tushare；信号计算增加分批+暂停（80/批、间隔 6s）规避限频，重跑当日信号全量成功（132 条，0 失败）                                                                |
