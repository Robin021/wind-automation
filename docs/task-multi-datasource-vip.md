# 任务记录：多数据源 + VIP用户系统

> 分支：`feature/multi-datasource-vip-system`  
> 创建日期：2024-12-11  
> 状态：🚧 进行中

## 背景

原 Wind API 已不可用，需要：
1. 重构数据获取层，支持多数据源（Tushare、AKShare等）
2. 新增用户VIP系统，按等级分配不同数量的股票
3. **架构升级为前后端分离模式，带管理后台**

## 已确认的设计决策

| 项目         | 决策                    | 备注                           |
| ------------ | ----------------------- | ------------------------------ |
| VIP等级体系  | ✅ 5级（0-4）            | 后台可配置                     |
| 股票分配策略 | ✅ 随机分配              |                                |
| 数据源优先级 | ✅ Tushare → AKShare     | Token 配置在 .env.local        |
| 技术架构     | ✅ 前后端分离 + 管理后台 | FastAPI + Vue 3 + Element Plus |

---

## 技术架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (待定)                               │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│   │  管理后台   │  │  用户端    │   │   看板      │            │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
└──────────┼────────────────┼────────────────┼────────────────────┘
           │                │                │
           ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     后端 API (FastAPI)                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ 用户管理 │ │ 股票分配 │ │ 数据服务 │ │ 系统配置 │           │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘           │
│       └────────────┴────────────┴────────────┘                  │
│                          │                                      │
│  ┌───────────────────────┴───────────────────────┐             │
│  │              业务逻辑层                         │             │
│  │  SignalEngine │ StockAllocator │ DataFetcher  │             │
│  └───────────────────────┬───────────────────────┘             │
└──────────────────────────┼──────────────────────────────────────┘
                           │
┌──────────────────────────┼──────────────────────────────────────┐
│                     数据层                                       │
│  ┌─────────────┐  ┌─────────────────────────────────┐          │
│  │   SQLite    │  │    DataSourceManager            │          │
│  │  /PostgreSQL│  │  ┌─────────┐ ┌─────────┐       │          │
│  │             │  │  │Tushare  │ │AKShare  │       │          │
│  │ - users     │  │  └─────────┘ └─────────┘       │          │
│  │ - stocks    │  └─────────────────────────────────┘          │
│  │ - allocations│                                               │
│  │ - configs   │                                                │
│  └─────────────┘                                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 任务拆解

### Phase 0 · 项目重构 & 基础架构

| #   | 任务                        | 状态     | 备注                               |
| --- | --------------------------- | -------- | ---------------------------------- |
| 0.1 | 项目目录结构重组            | ✅ 已完成 | backend/, frontend/                |
| 0.2 | FastAPI 项目初始化          | ✅ 已完成 | 路由、中间件、异常处理             |
| 0.3 | 数据库模型设计 (SQLAlchemy) | ✅ 已完成 | User, Stock, Allocation, Config 表 |
| 0.4 | 用户认证系统 (JWT)          | ✅ 已完成 | 登录、注册、权限控制               |
| 0.5 | 环境变量 & 配置管理         | ✅ 已完成 | pydantic-settings, .env.local      |

### Phase 1 · 多数据源架构

| #   | 任务                       | 状态     | 备注                                                |
| --- | -------------------------- | -------- | --------------------------------------------------- |
| 1.1 | 设计 `DataSource` 抽象基类 | ✅ 已完成 | 定义统一接口：get_daily_data, get_realtime_quote 等 |
| 1.2 | 实现 `TushareDataSource`   | ✅ 已完成 | 需要 token 配置                                     |
| 1.3 | 实现 `AKShareDataSource`   | ✅ 已完成 | 免费，无需 token                                    |
| 1.4 | 实现 `DataSourceManager`   | ✅ 已完成 | 支持优先级、自动降级、健康检查                      |
| 1.5 | 数据源 API 接口            | ✅ 已完成 | 暴露给前端调用                                      |

### Phase 2 · 用户 VIP 系统

| #   | 任务                              | 状态     | 备注                                     |
| --- | --------------------------------- | -------- | ---------------------------------------- |
| 2.1 | 用户模型 & CRUD API               | ✅ 已完成 | 字段：id, name, vip_level, created_at 等 |
| 2.2 | VIP 等级配置（后台可调）          | ✅ 已完成 | 存入数据库，支持动态修改                 |
| 2.3 | 实现股票分配策略 `StockAllocator` | ✅ 已完成 | 随机分配，按 VIP 等级控制数量            |
| 2.4 | 分配记录存储 & 查询               | ✅ 已完成 | allocations 表                           |
| 2.5 | 用户分配结果导出 API              | ⬜ 待开始 | JSON / Excel                             |

### Phase 3 · 管理后台 API

| #   | 任务               | 状态     | 备注                    |
| --- | ------------------ | -------- | ----------------------- |
| 3.1 | 用户管理接口       | ✅ 已完成 | 增删改查、VIP 升降级    |
| 3.2 | 股票池管理接口     | ✅ 已完成 | 导入、编辑、删除        |
| 3.3 | 系统配置接口       | ✅ 已完成 | VIP等级配置、分配策略等 |
| 3.4 | 数据源状态监控接口 | ✅ 已完成 | 健康检查、切换日志      |

### Phase 4 · 信号系统

| #   | 任务                | 状态     | 备注                         |
| --- | ------------------- | -------- | ---------------------------- |
| 4.1 | 重构 `SignalEngine` | ⬜ 待开始 | 适配新数据源                 |
| 4.2 | 信号 API            | ⬜ 待开始 | 生成、查询、按用户过滤       |
| 4.3 | 用户维度的信号分发  | ⬜ 待开始 | 每个用户只收到自己的股票信号 |

### Phase 5 · 前端（Vue 3 + Element Plus）

| #   | 任务          | 状态     | 备注                 |
| --- | ------------- | -------- | -------------------- |
| 5.1 | 管理后台界面  | ✅ 已完成 | 用户管理、配置管理   |
| 5.2 | 用户登录/注册 | ✅ 已完成 |                      |
| 5.3 | 用户个人看板  | ✅ 已完成 | 查看自己的股票、信号 |
| 5.4 | 数据可视化    | ⬜ 待开始 | 行情图表等           |

### Phase 6 · 支付 / 订阅（VIP 自动开通）

| #   | 任务                              | 状态     | 备注                                                                 |
| --- | --------------------------------- | -------- | -------------------------------------------------------------------- |
| 6.1 | 支付订单模型（PaymentOrder）      | ⬜ 待开始 | 订单号、用户、金额、VIP目标等级、状态（pending/paid/failed/refund） |
| 6.2 | 回调事件表（WebhookEvent，可选）  | ⬜ 待开始 | 幂等处理、审计追踪、防重复通知                                       |
| 6.3 | 支付创建接口（/payments/create）  | ⬜ 待开始 | 返回支付参数/支付链接（按渠道：微信/支付宝/Stripe 等）               |
| 6.4 | 支付回调接口（/payments/webhook） | ⬜ 待开始 | 验签 + 幂等 + 更新订单状态 + 开通/续费 VIP                           |
| 6.5 | VIP 开通策略（paid → grant VIP）  | ⬜ 待开始 | 只允许“回调确认支付成功”后变更 vip_level，避免前端伪造               |
| 6.6 | 前端「会员中心/充值」页面         | ⬜ 待开始 | 用户发起购买、展示订单状态、展示 VIP 到期/权益                       |
| 6.7 | 管理后台订单查询/补单/退款入口     | ⬜ 待开始 | 管理员可查订单、手工对账（慎用）、触发退款（如渠道支持）             |

#### Phase 6 关键设计（结合当前系统）

- **订阅周期**：固定 **3个月**（和“股票池三个月一换”对齐）
- **订阅有效期存储**：建议新增 `user_subscriptions` 表（避免直接改 `users` 表导致存量库迁移问题）
  - 字段建议：`user_id`（唯一）、`vip_level`、`starts_at`、`expires_at`、`updated_at`
  - 服务端判定 VIP 是否有效：`expires_at` 未到期才按 `vip_level` 生效；到期则视为 VIP0（可选择懒更新或定时降级）
- **价格配置（管理员可调）**：新增 `vip_price_configs` 表，由管理后台配置不同 VIP 的 3 个月价格
  - 字段建议：`vip_level`、`duration_months=3`、`price_fen`、`enabled`、`updated_at`
- **支付渠道**：微信支付（建议走 **微信支付 V3**）
- **VIP 等级与胜率更高的预留**：
  - 支付/订阅只负责“权益生效”，不要把“更高胜率”逻辑写死在支付里
  - 后续可以把分配策略扩展为：`vip_level` 映射不同的选股/分配策略（比如更严格的信号过滤、更优股票池）

#### 微信支付（V3）建议落点

- **后端**：
  - `POST /api/v1/payments/wechat/create`：创建订单，返回 `out_trade_no` +（按接入形态返回）`code_url` / `h5_url` / `prepay_id`
  - `POST /api/v1/payments/wechat/notify`：微信异步回调（验签 + 幂等），把订单置为 `paid`，并延长 `vip_expires_at`（加 3 个月）
  - `GET /api/v1/payments/my-orders`：用户查看自己的订单
  - `GET/POST /api/v1/config/vip-prices`：管理员配置各 VIP 3 个月价格（用于下单时定价）
- **前端（Vue）**：
  - 新增“会员中心”页：选择 VIP 等级（或统一订阅）→ 下单 → 展示二维码/跳转 → 轮询订单状态

#### 多场景覆盖建议（落地顺序）

- **Phase A（最快上线）**：PC Web 走 **Native 扫码** + 手机浏览器走 **H5**
  - 好处：不需要用户微信 `openid` 绑定，直接用现有 web 登录体系即可
- **Phase B（体验最好）**：公众号内 Web 走 **JSAPI（公众号 appid）**
  - 需要：用户微信 OAuth 获取 `openid` 并与 `user_id` 绑定
- **Phase C（小程序）**：小程序走 **JSAPI（小程序 appid）**
  - 需要：小程序登录态 `code2session` 获取 `openid` 并绑定

---

## VIP 等级设计 ✅ 已确认

| VIP等级 | 名称     | 股票数量上限 | 说明     |
| ------- | -------- | ------------ | -------- |
| 0       | 免费用户 | 5            | 基础体验 |
| 1       | VIP1     | 10           |          |
| 2       | VIP2     | 20           |          |
| 3       | VIP3     | 50           |          |
| 4       | SVIP     | 不限         | 全量股票 |

> 💡 等级配置存储在数据库，管理员可在后台动态调整

---

## 股票分配策略 ✅ 已确认

采用 **随机分配** 策略：
- 从总股票池中随机抽取
- 数量由用户 VIP 等级决定
- 每次分配记录入库，支持历史查询

---

## 变更日志

| 日期       | 变更内容                                                                                                                                                                           |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2024-12-11 | 创建任务文档，建立分支                                                                                                                                                             |
| 2024-12-11 | 确认 VIP 等级、分配策略、数据源优先级                                                                                                                                              |
| 2024-12-11 | 架构升级为前后端分离，新增管理后台需求                                                                                                                                             |
| 2024-12-11 | 管理后台支持管理员创建用户                                                                                                                                                         |
| 2024-12-11 | 确认前端技术栈：Vue 3 + Element Plus                                                                                                                                               |
| 2024-12-11 | 完成后端 API 开发（Phase 0-3）                                                                                                                                                     |
| 2024-12-11 | 完成前端基础页面开发（Phase 5）                                                                                                                                                    |
| 2025-12-11 | 重新启用 AKShare 兜底并重跑信号；后续确认 .env.local 已加载但 Tushare token 无对应接口权限（doc_id=108 提示），Tushare 不可用；AKShare 因远端断开（Eastmoney）全部失败，信号未更新 |
| 2025-12-11 | 新增 TUSHARE_BASE_URL 配置，Tushare 请求域支持自定义（如 http://tushare.nlink.vip）；使用新 token + 自定义域重跑信号，已成功（Buy/Sell/Hold 更新完成）                             |
| 2025-12-11 | 关闭 AKShare，仅用 Tushare；信号计算增加分批+暂停（80/批、间隔 6s）规避限频，重跑当日信号全量成功（132 条，0 失败）                                                                |
| 2025-12-12 | 补充 Phase 6：支付/订阅接入方案（订单模型、回调验签与幂等、paid 后自动开通/续费 VIP、前端会员中心与后台订单管理）                                                                   |
| 2025-12-12 | 开始接入微信支付 V3 真链路：加入签名下单、回调验签、回调 resource 解密；并修复启动时模型未 import 导致新表不创建的问题                                                                  |
