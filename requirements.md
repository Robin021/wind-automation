## 背景
每天收盘后，根据 `stocks.xlsx` 中维护的股票池，使用 Wind API 获取日线行情与 Chaikin 指标（自定义公式 `chaikin2`），筛选需要交易的标的，并在夜间 21:30 之后通过 Wind 交易接口（torder）批量挂单，以确保委托尽早排队。

## 运行概述
- **触发方式**：目前手动运行程序（后续可扩展为定时任务）。
- **执行流程**：
  - **收盘后阶段**：下载行情数据 → 计算并筛选信号 → 生成待下单任务（保存到文件）。
  - **夜间委托阶段（21:30+）**：手动运行程序（或人工确认后执行）→ 程序自动通过 `w.tlogon` 登录交易账户 → 根据待下单任务批量委托 → 即时记录接口返回 → 程序自动通过 `w.tlogout` 登出。
  - **次日核对阶段**：在下一个交易日上午（建议 09:30 以后）自动查询委托/成交结果，与状态文件对账并更新持仓。

## 指标说明
```
FORMULANAME:CHAIKIN;
INPUT:SHORT(3,1,100),LONG(24,1,100),N(24,1,60);
MID:=SUM(VOLUME*(2*MATCH-HIGH-LOW)/(HIGH+LOW),0);
CHO:MA(MID,SHORT)-MA(MID,LONG),color3;
MACHO:MA(CHO,N),color6;
```
- Wind 公式中的 `MATCH` 为 Wind 内置价格字段（与收盘价不同，保留该写法以便得到官方 Chaikin 结果）。
- 指标返回两个序列：`CHO` 与 `MACHO`。`CHO` 用于买卖信号判断。

## 详细需求
1. **股票池读取**
   - 从 `stocks.xlsx` 中读取所有需要处理的 A 股代码，支持多市场后缀（如 `600000.SH`）。
   - 如遇空行或无效代码需跳过并记录。

2. **行情与指标下载**
   - 使用 `w.wsd` 获取日线数据，至少包含 `OPEN,HIGH,LOW,CLOSE,VOLUME,TURN` 等基本字段以及 `CHO`、`MACHO`（可通过 `chaikin2` 自定义公式或等效指标字段获取）。
     - `w.wsd` 仅支持「单代码多字段」或「多代码单字段」，因此本系统按股票逐只循环拉全字段；如需提速，可做并发分组请求，但单次调用不得同时包含多代码多字段。
   - 下载区间覆盖本次信号计算所需的最短历史窗口（至少 `LONG + N` 个交易日，以当前参数建议取最近 60 个交易日）。
   - 数据保存为 CSV，路径 `data/stocks/{code}.csv`，增量更新，避免重复写入。
   - 输出 CSV 至少包含：日期、基本行情字段、`CHO`、`MACHO`，并保留最新一次下载时间戳。

3. **信号筛选逻辑**
   - **买入信号**：若 T 日 `CHO` > T-1 日 `CHO`，则触发买入候选。
   - **卖出信号**：仅对当前持仓股票判断。若 T 日 `CHO` < T-1 日 `CHO`，则将该持仓标记为“待观察”并记录观察起始日；在下一交易日收盘后，若最新 `CHO` 仍低于上一交易日，则在信号引擎中触发卖出候选。通过持仓状态文件记录观察状态，可以在每日收盘批处理中准确回溯 T、T-1、T-2 的比较。
   - 新买入股票进入持仓后，后续同样按上述卖出逻辑处理；持仓状态需存储 `pending_sell_since` 等字段以便跨日追踪。
   - 可选附加条件（占位，可后续扩展）：结合 `MACHO` 过滤信号、成交量阈值等。

4. **交易执行**
   - 每只股票买入数量固定为 1 手（A 股默认为 100 股；如存在不同最小交易单位需兼容）。
   - 夜间 21:30 之后调用 `w.torder` 批量下单，紧跟待下单任务中的方向；如需拆分多账户/多策略，可按照待下单任务文件分批提交。
   - 买入价格为当日涨停价、卖出价格为当日跌停价，需根据实际标的的涨跌幅限制与价位单位计算：
     - 默认主板 ±10%，ST/ *ST ±5%，创业板/北交所/科创板 ±20%；上市首日或特别处理股票按交易所公布的临时比例，必要时可从 Wind 字段（如 `up_down_limit_type`）或柜台接口获取。
     - 价格保留到交易所允许的最小价位（主板 0.01，科创板/创业板 0.01，北交所 0.001 等），并处理四舍五入后的合规性检查。
   - 对于下单成功与失败分别记录，失败则不重试交易，仅在日志中注明。

5. **状态与结果记录**
   - 维护持仓/信号状态文件（推荐 `data/positions.csv` 或轻量数据库），字段包括：`code`、`status`（0=未持仓，1=已买入，2=已卖出）、`last_buy_price`、`last_sell_price`、`pending_sell_since`、`last_signal_time`、`hold_volume` 等。
   - 收盘批次结束后根据状态文件生成 `data/pending_orders/{YYYYMMDD}.json`，夜间委托阶段直接读取执行。
   - 夜间下单完成后立刻记录 `w.torder` 返回和 `w.tquery("Order", RequestID=...)` 的即时受理结果（若柜台立即回报）。
   - 次一交易日上午（09:30 以后）再次调用 `w.tquery("Order")`、`w.tquery("Trade")` 获取实际排队/成交情况，并按查询结果写入 `data/trades/{YYYYMMDD}.csv`，字段包含股票代码、买卖方向、委托价格、成交均价、成交数量、成交时间、委托号/成交号等。

## 数据存储方案

### 推荐方案：混合存储
- **历史行情数据**：使用 CSV 格式，按股票代码分文件存储
  - 路径：`data/stocks/{code}.csv`
  - 优点：便于备份、查看、按需加载单只股票数据
  - 字段：`date,open,high,low,close,volume,turn,cho,macho,update_time`
  
- **持仓状态数据**：使用 SQLite 数据库（推荐）或 CSV
  - SQLite 路径：`data/trading.db`（表：`positions`）
  - CSV 路径：`data/positions.csv`（备选方案）
  - 字段：`code,status,last_buy_price,last_sell_price,last_signal_time,pending_sell_since,hold_volume,update_time`
  - 选择 SQLite 的原因：状态数据需要频繁更新和查询，SQLite 性能更好且支持事务
  
- **交易记录**：使用 CSV 格式，按日期分文件
  - 路径：`data/trades/{YYYYMMDD}.csv`
  - 字段：`code,trade_side,order_price,traded_price,traded_volume,traded_time,order_number`
  - 优点：按日期归档，便于按时间范围查询
  
- **待下单任务**：使用 JSON 格式（临时数据）
  - 路径：`data/pending_orders/{YYYYMMDD}.json`
  - 格式：`[{"code": "600000.SH", "side": "Buy", "price": 10.00, "volume": 100, "signal_time": "2024-01-01 15:00:00"}]`
  - 优点：结构化数据，便于程序读取和处理

### 目录结构
```
data/
├── stocks/              # 历史行情数据（CSV）
│   ├── 600000.SH.csv
│   └── 000001.SZ.csv
├── trading.db           # 持仓状态（SQLite，可选）
├── positions.csv        # 持仓状态（CSV备选）
├── trades/              # 交易记录（CSV）
│   ├── 20240101.csv
│   └── 20240102.csv
└── pending_orders/      # 待下单任务（JSON）
    └── 20240101.json
```

### 数据备份建议
- 定期备份 `data/` 目录（建议每日收盘后）
- 重要数据（持仓状态、交易记录）建议版本控制或定期导出

6. **登录/登出管理**
   - 使用 `w.tlogon` 在交易前登录，完成所有操作后调用 `w.tlogout`（或关闭 WindPy 会话）。
   - 当前只支持单账户运行，`LogonID` 可用于日志记录但无需额外传入；后续扩展多账户时再在指令 options 中附带。

7. **错误处理与重试**
   - Wind API 调用失败时需按配置（例如最多重试 3 次，间隔 1-3 秒）自动重试。
   - 重试后仍失败则记录错误并跳过该标的/步骤，不再尝试交易。
   - 对网络超时、数据缺失等情况进行分类记录，方便排查。

8. **日志与监控**
   - 统一日志输出（建议 `logs/app.log`），至少包含 INFO/ERROR 级别。
   - 核心事件：登录状态、数据下载、信号筛选结果、下单请求与响应、查询结果、异常详情。
   - 日志需可读，可用于追溯整个交易流程。

## 后续可拓展（暂不实施）
- 定时任务触发（如使用 cron/调度器）。
- 增加风控：资金占比限制、同一方向最大持仓数量。
- 更多指标组合或策略回测。
